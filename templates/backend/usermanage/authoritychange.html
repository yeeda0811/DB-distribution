<?php include(__DIR__ . '/../basic/header.html'); ?>
<div class="container-fluid">
    <div class="card">
        <div class="card-header">權限變更</div>
        <div class="card-body">
            <div class="row">
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#userManageModal"
                        data-type="add" onchange="select()">新增</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                </div>
            </div>
            <div class="row">
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>使用者</option>
                            <option>管理者</option>
                            <option>農民</option>
                            <option>中盤商</option>
                            <option>物流人員</option>
                        </select>
                    </div>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限選擇:</label>
                    <div class="col-auto">
                        <select class="form-control" id="tool_type" name="tool_type" onchange="select()">
                            <option disabled selected>請選擇</option>
                            <option value="使用者">使用者</option>
                            <option value="管理者">管理者</option>
                            <option value="農民">農民</option>
                            <option value="中盤商">中盤商</option>
                            <option value="物流人員">物流人員</option>
                        </select>
                    </div>
                </div>
            </div>
            <table id="role" class="table table-striped table-bordered " style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th>角色</th>
                        <th>權限</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="modal fade" id="RoleModal" tabindex="-1" aria-labelledby="RoleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="RoleModalLabel">新增帳號</h3>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary">確認</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="userManageModal" tabindex="-1" aria-labelledby="RoleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="RoleModalLabel">新增帳號</h3>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary">確認</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<?php include(__DIR__ . '/../basic/footer.html'); ?>

<script type="text/javascript">
    let datatables_setting = {
        "ordering": false,
        "destroy": true,
        "searching": false,
        "language": {
            "processing": "處理中...",
            "loadingRecords": "載入中...",
            "lengthMenu": "顯示 _MENU_ 項結果",
            "zeroRecords": "沒有符合的結果",
            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
            "infoFiltered": "(從 _MAX_ 項結果中過濾)",
            "infoPostFix": "",
            "search": "搜尋:",
            "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
            },
            "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
            }
        },
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true
            }
        }],
        'select': {
            'style': 'multi'
        },
    };
    $(function () {
        initDatatablesRoles();
    });
    let timeout = {
        'inputSearchRoles': null
    };
    $(document).on('input', '#inputSearchRoles', function () {
        if (timeout['inputSearchRoles'] != null) {
            clearTimeout(timeout['inputSearchRoles']);
        }
        timeout['inputSearchRoles'] = setTimeout(initDatatablesRoles, 1000);
    });
    function initDatatablesRoles() {
        $('#role').DataTable().destroy();
        let datatables_setting_items = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_items["processing"] = true;
        datatables_setting_items["serverSide"] = true;
        datatables_setting_items["ajax"] = {
            "url": "/admin/authoritychange/authorithies",
            "data": function (d) {
                d.search = $('#inputSearchRoles').val();
            }
        };
        datatables_setting_items["columns"] = [
            { "data": "role_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#RoleModal" data-type="edit" data-id="${row.role_id}" disabled>${row.role_name}</button>`;
                }
            },
            { "data": "permission_names" },
        ];
        $('#role').DataTable(datatables_setting_items);
    }
    function handleModalEditable() {
        if($('[name="buttonModalEditable"]').prop("disabled") == true){
            $('[name="buttonModalEditable"]').prop('disabled', false);
        }else if($('[name="buttonModalEditable"]').prop("disabled") == false){
            $('[name="buttonModalEditable"]').prop('disabled', true);
        }
        
    }

    let role;
    function select() {
        role = document.getElementById("tool_type").value;
        console.log(role)
    }

    $(document).on('show.bs.modal', '#userManageModal', function select(e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');

        if (role == "管理者") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色：</label>
                    <p>${role}</p>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>管理介面</option>
                            <option>管理使用者</option>
                            <option>回覆評論</option>
                        </select>
                    </div>
                </div>
            </form>
        `);
        } else if (role == "使用者") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色：</label>
                    <p>${role}</p>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>下訂單</option>
                            <option>評論</option>
                        </select>
                    </div>
                </div>
            </form>
        `);
        } else if (role == "農民") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色：</label>
                    <p>${role}</p>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>上架貨品</option>
                            <option>價格制定</option>
                        </select>
                    </div>
                </div>
            </form>
        `);
        } else if (role == "中盤商") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色：</label>
                    <p>${role}</p>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>買進價格</option>
                            <option>價格制定</option>
                        </select>
                    </div>
                </div>
            </form>
        `);
        } else if (role == "物流人員") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">角色：</label>
                    <p>${role}</p>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">權限:</label>
                    <div class="col-auto">
                        <select class="form-control">
                            <option disabled selected>請選擇</option>
                            <option>到貨時間</option>
                            <option>物流公司</option>
                        </select>
                    </div>
                </div>
            </form>
        `);
        }
    })
</script>