<?php include(__DIR__ . '/../basic/header.html'); ?>
<div class="container-fluid">
    <div class="card">
        <div class="card-header">使用者管理</div>
        <div class="card-body">
            <div class="row">
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#userManageModal"
                        data-type="add">新增</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#userManageModal"
                        data-type="delete">刪除</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#userManageModal"
                        data-type="export">匯出</button>
                </div>

                <div class="modal fade" id="userManageModal" tabindex="-1" aria-labelledby="userManageModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title" id="userManageModalLabel">新增帳號</h3>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary">確認</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="sureModal" tabindex="-1" aria-labelledby="reviseModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title" id="sureModalLabel"></h3>
                            </div>
                            <div class="modal-body">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="sure">確認</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">身份：</label>
                    <div class="col-auto">
                        <select class="form-control" id="selectRoleType">
                            <option disabled selected>請選擇</option>
                            <!-- <option>使用者</option>
                            <option>管理者</option>
                            <option>農民</option> -->
                        </select>
                    </div>
                </div>
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">名稱：</label>
                    <div class="col-auto">
                        <input class="form-control" id="inputSearchAccounts" type="text" placeholder="Ex.yeeda" />
                    </div>
                </div>
                <div class="col-auto row form-group">
                    <div class="col-auto">
                        <button class="btn btn-primary" type="button">查詢</button>
                    </div>
                </div>
            </div>
            <table id="account" class="table table-striped table-bordered " style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th>帳號</th>
                        <th>密碼</th>
                        <th>名稱</th>
                        <th>EMAIL</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<?php include(__DIR__ . '/../basic/footer.html'); ?>

<script type="text/javascript">
    let datatables_setting = {
        "ordering": false,
        "destroy": true,
        "searching": false,
        "language": {
            "processing": "處理中...",
            "loadingRecords": "載入中...",
            "lengthMenu": "顯示 _MENU_ 項結果",
            "zeroRecords": "沒有符合的結果",
            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
            "infoFiltered": "(從 _MAX_ 項結果中過濾)",
            "infoPostFix": "",
            "search": "搜尋:",
            "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
            },
            "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
            }
        },
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true
            }
        }],
        'select': {
            'style': 'multi'
        },
    };
    let accounts = [];
    let identity = [];
    $(function () {
        initDatatablesAccounts();
        getAccount();
        getAccountIdentity();
        $(identity).each(function (index) {
            $('#selectRoleType').append(`
                <option value="${index}">${this.role_name}</option>
            `);
        })
    });
    function getAccount() {
        $.ajax({
            url: `/admin/usermanage/allrole`,
            type: 'get',
            success: function (response) {
                accounts = response;
            }
        })
    }
    function getAccountIdentity() {
        $.ajax({
            url: `/admin/usermanage/identity`,
            type: 'get',
            async: false,
            success: function (response) {
                identity = response;
            }
        })
    }
    let timeout = {
        'inputSearchAccounts': null
    };
    $(document).on('input', '#inputSearchAccounts', function () {
        if (timeout['inputSearchAccounts'] != null) {
            clearTimeout(timeout['inputSearchAccounts']);
        }
        timeout['inputSearchAccounts'] = setTimeout(initDatatablesAccounts, 1000);
    });
    $(document).on('change', '#selectRoleType', function () {
        initDatatablesAccounts();
    });
    function initDatatablesAccounts() {
        $('#account').DataTable().destroy();
        let datatables_setting_items = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_items["processing"] = true;
        datatables_setting_items["serverSide"] = true;
        datatables_setting_items["ajax"] = {
            "url": "/admin/usermanage/accounts",
            "data": function (d) {
                d.item_type = $('#selectRoleType').val();
                d.search = $('#inputSearchAccounts').val();
            }
        };
        datatables_setting_items["columns"] = [
            { "data": "user_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#userManageModal" data-type="edit" data-id="${row.user_id}" data-name="user_id" disabled>${row.account}</button>`;
                }
            },
            { "data": "password" },
            { "data": "user_name" },
            { "data": "email" }
        ];
        $('#account').DataTable(datatables_setting_items);
    }
    function handleModalEditable() {
        if ($('[name="buttonModalEditable"]').prop("disabled") == true) {
            $('[name="buttonModalEditable"]').prop('disabled', false);
        } else if ($('[name="buttonModalEditable"]').prop("disabled") == false) {
            $('[name="buttonModalEditable"]').prop('disabled', true);
        }

    }

    $(document).on('show.bs.modal', '#userManageModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add" || type == "edit") {
            $('#userManageModal').find('.modal-body').html(`
            <form>
                <div class="form-group row">
                    <label class="col-form-label col-sm-auto">帳號 : </label>
                    <div class="col-sm">
                        <input type="input" id="inputaccount" class="form-control" placeholder="ex.mil123456"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-form-label col-sm-auto">密碼 : </label>
                    <div class="col-sm">
                        <input type="input" id="inputpassword" class="password form-control" placeholder="ex.Password1">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-form-label col-sm-auto">Email: </label>
                    <div class="col-sm">
                        <input type="email" id="inputemail" class="email form-control" placeholder="ex.example@example.com">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-form-label col-sm-auto">姓名 : </label>
                    <div class="col-sm">
                        <input type="name" id="inputname" class="name form-control" placeholder="ex.吳小達">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="form-check-label col-sm-auto">角色: </label>
                    <div class="col-sm">
                        <div class="row" id="divFormInlineRoles">
                        </div>          
                    </div>
                 </div>
            </form>
        `);
            $(accounts).each(function (index) {
                $('#divFormInlineRoles').append(`
                    <div class="col-sm-4">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="inputCheckboxRoles" id="role_${this.role_id}" value="${this.role_id}">
                            <label class="form-check-label" for="role_${this.role_id}">${this.role_name}</label>
                        </div>
                    </div>
                `);
            })

        } if (type == "add") {
            $('#userManageModal').find('.modal-title').text('新增帳號');
            $('#itemManageModal').find('.modal-footer').html(`
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureModal"
                data-dismiss="modal"  data-type="add_user">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            `);
        } else if (type == "edit") {
            $('#userManageModal').find('.modal-title').text('編輯帳號');
            $('#itemManageModal').find('.modal-footer').html(`
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureModal"
                    data-dismiss="modal" id="edit_confirm" data-type="revise_user">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>     
            `);
            let user_id = $(source).attr('data-id');
            $.ajax({
                url: `/admin/usermanage/role`,
                type: 'get',
                data: {
                    user_id: user_id
                },
                success: function (response) {
                    $(response).each(function () {
                        let row = this;
                        $('#userManageModal').find('#inputaccount').val(row.account);
                        $('#userManageModal').find('#inputpassword').val(row.password);
                        $('#userManageModal').find('#inputemail').val(row.email);
                        $('#userManageModal').find('#inputname').val(row.user_name);
                        $(row.roles).each(function () {
                            $(`[name="inputCheckboxRoles"][value="${this.role_id}"]`).prop('checked', true);
                        })
                    })
                }
            });
        } else if (type == "delete") {
            $('#userManageModal').find('.modal-title').text('刪除帳號')
            $('#userManageModal').find('.modal-body').html(`您確定要刪除嗎？`);
            $('#userManageModal').find('.modal-footer').html(`
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="delete_user_row">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                `);
        } else if (type == "export") {
            $('#userManageModal').find('.modal-title').text('匯出資料')
            $('#userManageModal').find('.modal-body').html(`
            您確定要匯出嗎？
        `);
        }
    })

    $(document).on('click', '#delete_user_row', function (e) {
        let data_arr = [];
        let data = {};
        $('input[type="checkbox"]:checked').each(function () {
            data = {};
            data['user_id'] = $(this).closest(`tr`).find(`[data-name="user_id"]`).attr('data-id');
            data_arr.push(data);
        });
        $.ajax({
            url: `/admin/usermanage/account/deleteuser`,
            type: 'delete',
            data: {
                data: data_arr
            },
            success: function (response) {
                initDatatablesAccounts();
            }
        })
    })

    $(document).on('click', '#sure', function (e) {
        let type = $(this).attr("type");
        let data = {};
        let form = {};
        if (type === "add_user") {
            data = {};
            $("[name='add_user']").each(function (index, obj) {
                index = $(this).attr("data-name");
                if (this.type == "text") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "checkbox") {
                    obj = [];
                    $("input:checkbox[name=add_item]:checked").each(function () {
                        obj.push($(this).val());
                    });
                    data[index] = obj;
                } else if (this.type == "textarea") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "file") {
                    obj = file_ids;
                    data[index] = obj;
                }
            });
            $.ajax({
                url: `/admin/productmanage/item/additem`,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function (response) {
                    initDatatablesItems();
                }
            })
        } else if (type === 'revise_item') {
            data = {};
            $("[name='add_item']").each(function (index, obj) {
                index = $(this).attr("data-name");
                if (this.type == "text") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "select-one") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "checkbox") {
                    obj = [];
                    $("input:checkbox[name=add_item]:checked").each(function () {
                        obj.push($(this).val());
                    });
                    data[index] = obj;
                } else if (this.type == "textarea") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "file") {
                    obj = file_ids;
                    data[index] = obj;
                }
            });
            data['item_id'] = $('#itemManageModal').find('#edit_confirm').attr('item_id');
            console.log(data);
            $.ajax({
                url: `/admin/productmanage/item/edititem`,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function (response) {
                    $("[name='add_item']").each(function () {
                        $('#item').find(`[data-id="${data['item_id']}"]`).closest(`tr`).find(`[type="${this.id}"]`).text(data[`${this.id}`]);
                    })
                    console.log(`datatables['item'].draw(false);`);
                    datatables['item'].draw(false);
                }
            })
        }
    })

</script>