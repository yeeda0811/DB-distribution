<?php include(__DIR__ . '/../basic/header.html'); ?>
<div class="container-fluid">
    <div class="card">
        <div class="card-header">優惠卷管理</div>
        <div class="card-body">
            <div class="row">
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#discountManageModal"
                        data-type="add">新增</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#discountManageModal"
                        data-type="delete">刪除</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#discountManageModal"
                        data-type="export">匯出</button>
                </div>
            </div>
            <div class="row">
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">搜尋：</label>
                    <div class="col-auto">
                        <input type="text" class="form-control" id="inputSearchDiscounts" />
                    </div>
                </div>
            </div>
            <table id="discount" class="table table-striped table-bordered" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th>優惠卷名稱</th>
                        <th>種類</th>
                        <th>折抵低消</th>
                        <th>折抵金額</th>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="modal fade" id="discountManageModal" tabindex="-1" aria-labelledby="discountManageModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="discountManageModalLabel"></h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- reviseModal -->
        <div class="modal fade" id="sureDiscountModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="sureDiscountModalLabel"></h5>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" id="discountsure">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<?php include(__DIR__ . '/../basic/footer.html'); ?>
<script type="text/javascript">
    let datatables_setting = {
        "ordering": false,
        "destroy": true,
        "searching": false,
        "language": {
            "processing": "處理中...",
            "loadingRecords": "載入中...",
            "lengthMenu": "顯示 _MENU_ 項結果",
            "zeroRecords": "沒有符合的結果",
            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
            "infoFiltered": "(從 _MAX_ 項結果中過濾)",
            "infoPostFix": "",
            "search": "搜尋:",
            "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
            },
            "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
            }
        },
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true
            }
        }],
        'select': {
            'style': 'multi'
        },
    };
    let discountType = [];
    let datatables = [];
    $(function () {
        initDatatablesDiscounts();
        getDiscountType();
    });
    function getDiscountType() {
        $.ajax({
            url: `/admin/productmanage/discount/discountType`,
            type: 'get',
            success: function (response) {
                discountType = response;
            }
        })
    }
    let timeout = {
        'inputSearchDiscounts': null
    };
    $(document).on('input', '#inputSearchDiscounts', function () {
        if (timeout['inputSearchDiscounts'] != null) {
            clearTimeout(timeout['inputSearchDiscounts']);
        }
        timeout['inputSearchDiscounts'] = setTimeout(initDatatablesDiscounts, 1000);
    });
    $(document).on('change', '#selectDiscountType', function () {
        initDatatablesDiscounts();
    });
    function initDatatablesDiscounts() {
        $('#discount').DataTable().destroy();
        let datatables_setting_discounts = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_discounts["processing"] = true;
        datatables_setting_discounts["serverSide"] = true;
        datatables_setting_discounts["ajax"] = {
            "url": "/admin/productmanage/discounts",
            "data": function (d) {
                d.item_type = $('#selectDiscountType').val();
                d.search = $('#inputSearchDiscounts').val();
                // d.custom = $('#myInput').val();
                // etc
            }
        };
        datatables_setting_discounts["columns"] = [
            { "data": "discount_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#discountManageModal" data-type="edit" data-id="${row.discount_id}" data-name="discount_id" disabled>${row.discount_name}</button>`;
                }
            },
            { "data": "discount_type_name" },
            { "data": "discount_price" },
            { "data": "discount_calculate" }
        ];
        datatables['discount'] = $('#discount').DataTable(datatables_setting_discounts);
    }
    function handleModalEditable() {
        $('[name="buttonModalEditable"]').prop('disabled', false);
    }

    $(document).on('show.bs.modal', '#discountManageModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add" || type == "edit") {
            $('#discountManageModal').find('.modal-body').html(`
                        <form>
                            <div class="form-group row">
                                <label for="add_discount_name" class="col-form-label col-sm-auto">優惠卷名稱</label>
                                <div class="col-sm">
                                    <input type="text" id="discount_name" class="form-control" name="add_discount" placeholder="ex.85折" />
                                </div>
                            </div>
                            <div class="form-group row">
                                    <label for="discount_type" class="col-form-label col-sm-auto">優惠卷種類</label>
                                    <div class="col-sm">
                                        <select class="form-control" id="discount_type_id" name="add_discount" >
                                            <option disabled selected>請選擇</option>
                                        </select>
                            </div>
                                    </div>
                                </div>
                            <div class="form-group row">
                                <label for="discount_describe" class="col-form-label col-sm-auto">折抵低消</label>
                                <div class="col-sm">
                                    <input type="text" class="form-control" id="discount_price" name="add_discount" placeholder="ex.100">
                                </div>
                                </div>
                            </div>
                            <div class="form-group row">
                                    <label for="discount_describe" class="col-form-label col-sm-auto">折抵金額</label>
                                    <div class="col-sm">
                                        <input type="text" class="form-control" id="discount_calculate" name="add_discount" placeholder="ex.打5折請輸入50，折抵100元請輸入100">
                                    </div>
                                    </div>
                                </div>
                        </form>
            `);
            $(discountType).each(function (index) {
                $('#discount_type_id').append(`
                        <option value="${index + 1}">${this.discount_type_name}</option>
                    `);
            })
            if (type == "add") {
                $('#discountManageModal').find('.modal-title').text('新增優惠卷');
                $('#discountManageModal').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureDiscountModal"
                            data-dismiss="modal" data-type="add_discount">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        `);
            } else if (type == "edit") {
                $('#discountManageModal').find('.modal-title').text('編輯優惠卷');
                $('#discountManageModal').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureDiscountModal"
                            data-dismiss="modal" id="discount_edit_confirm" data-type="revise_discount">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        `);

                let discount_id = $(source).attr('data-id');
                $.ajax({
                    url: `/admin/productmanage/discount/${discount_id}`,
                    type: 'get',
                    data: {
                        discount_id: discount_id
                    },
                    success: function (response) {
                        $(response).each(function () {
                            let row = this;
                            $('#discountManageModal').find('#discount_name').val(row.discount_name);
                            $(`#discount_type_id option[value="${row.discount_type_id}"]`).prop("selected", true);
                            $('#discountManageModal').find('#discount_price').val(row.discount_price);
                            $('#discountManageModal').find('#discount_calculate').val(row.discount_calculate);
                            $('#discountManageModal').find('#discount_edit_confirm').attr('discount_id', discount_id);
                        })
                    }
                });

            }
        } else if (type == "delete") {
            $('#discountManageModal').find('.modal-body').html('確定刪除嗎？');
            $('#discountManageModal').find('.modal-title').text('刪除優惠卷');
            $('#discountManageModal').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary" id="delete_discount_row" data-dismiss="modal">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        `);
        }
    })
    $(document).on('show.bs.modal', '#sureDiscountModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add_discount") {
            $('#sureDiscountModal').find('.modal-title').text('新增優惠卷');
            $('#sureDiscountModal').find('.modal-body').text('確定新增嗎？');
        } else if (type == "revise_discount") {
            $('#sureDiscountModal').find('.modal-title').text('編輯優惠卷');
            $('#sureDiscountModal').find('.modal-body').text('確定編輯嗎？');
        }
        $('#sureDiscountModal').find('.modal-footer').find("#discountsure").attr("type", type);
    })
    $(document).on('click', '#discountsure', function (e) {
        let type = $(this).attr('type');
        console.log(type);
        let data = {};
        let form = {};
        let check = true;
        if (type === "add_discount") {
            data = new Object();
            $("[name='add_discount']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            if (check === true) {
                $.ajax({
                    url: `/admin/productmanage/discount/addDiscount`,
                    type: 'post',
                    data: data,
                    success: function (response) {
                        initDatatablesDiscounts();
                    }
                })
            } else {
                $("#discountManageModal").modal('show');
            }
        } else if (type === "revise_discount") {
            data = new Object();
            $("[name='add_discount']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            data['discount_id'] = $('#discountManageModal').find('#discount_edit_confirm').attr('discount_id')
            console.log(data);
            if (check === true) {
                $.ajax({
                    url: `/admin/productmanage/discount/editDiscount`,
                    type: 'post',
                    data: data,
                    success: function (response) {
                        datatables['discount'].draw(false);

                    }
                })
            } else {
                $("#discountManageModal").modal('show');
            }
        }

    })
    $(document).on('click', '#delete_discount_row', function (e) {
        let data_arr = [];
        let data = {};
        $('input[type="checkbox"]:checked').each(function () {
            data = {};
            data['discount_id'] = $(this).closest(`tr`).find(`[data-name="discount_id"]`).attr('data-id');
            data_arr.push(data);
        });
        $.ajax({
            url: `/admin/productmanage/discount/deleteDiscount`,
            type: 'post',
            data: {
                data: data_arr
            },
            success: function (response) {
                initDatatablesDiscounts();
            }
        })
    })
</script>