<?php include(__DIR__ . '/../basic/header.html'); ?>
<div class="container-fluid"> 
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-item" role="tab"
                aria-controls="pills-home" aria-selected="true">貨品管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-import" role="tab"
                aria-controls="pills-profile" aria-selected="false">進貨管理</a>
        </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-item" role="tabpanel" aria-labelledby="pills-home-tab">
            <div class="card">
                <div class="card-header">貨品管理</div>
                <div class="card-body">
                    <div class="row">
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                data-target="#itemManageModal" data-type="add">新增</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-danger" data-toggle="modal"
                                data-target="#itemManageModal" data-type="delete">刪除</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-success" data-toggle="modal"
                                data-target="#itemManageModal" data-type="export">匯出</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-auto row form-group">
                            <label class="col-form-label col-auto">種類：</label>
                            <div class="col-auto">
                                <select class="form-control" id="selectItemType">
                                    <option disabled selected>請選擇</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-auto row form-group">
                            <label class="col-form-label col-auto">搜尋：</label>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="inputSearchItems" />
                            </div>
                        </div>
                    </div>

                    <table id="item" class="table table-striped table-bordered " style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th></th>
                                <th>商品名稱</th>
                                <th>種類</th>
                                <th>金額</th>
                                <th>數量</th>
                                <th>單位</th>
                                <th>上架人</th>
                                <th>描述</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="pills-import" role="tabpanel" aria-labelledby="pills-profile-tab">
            <div class="card">
                <div class="card-header">進貨紀錄</div>
                <div class="card-body">
                    <div class="row">
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                data-target="#importManageModal" data-type="add">新增</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-danger" data-toggle="modal"
                                data-target="#importManageModal" data-type="delete">刪除</button>
                        </div>
                        <div class="form-group col-auto">
                            <button type="button" class="btn btn-success" id="export_item">匯出</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-auto row form-group">
                            <label class="col-form-label col-auto">種類：</label>
                            <div class="col-auto">
                                <select class="form-control" id="selectImportType">
                                    <option disabled selected>請選擇</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-auto row form-group">
                            <label class="col-form-label col-auto">搜尋：</label>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="inputSearchImports" />
                            </div>
                        </div>
                    </div>

                    <table id="import" class="table table-striped table-bordered" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th></th>
                                <th>商品名稱</th>
                                <th>數量</th>
                                <th>進貨時間</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal fade" id="importManageModal" tabindex="-1" aria-labelledby="importManageModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title" id="importManageModalLabel"></h3>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="itemEnter">確認</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <div class="modal fade" id="itemManageModal" tabindex="-1" aria-labelledby="itemManageModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="itemManageModalLabel"></h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="itemEnter">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- reviseModal -->
        <div class="modal fade" id="sureModal" tabindex="-1" aria-labelledby="reviseModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="sureModalLabel"></h3>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" id="sure">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<?php include(__DIR__ . '/../basic/footer.html'); ?>
<script type="text/javascript">
    let file_ids = [];
    let datatables_setting = {
        "ordering": false,
        "destroy": true,
        "searching": false,
        "language": {
            "processing": "處理中...",
            "loadingRecords": "載入中...",
            "lengthMenu": "顯示 _MENU_ 項結果",
            "zeroRecords": "沒有符合的結果",
            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
            "infoFiltered": "(從 _MAX_ 項結果中過濾)",
            "infoPostFix": "",
            "search": "搜尋:",
            "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
            },
            "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
            }
        },
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true,
                className: 'select-checkbox'
            }
        }],
        'select': {
            'style': 'multi'
        },
    };
    let itemtypes = [];
    let itemUnit = [];
    let userItems = [];
    let datatables = [];
    $(function () {
        initDatatablesItems();
        initDatatablesImports();
        getItemTypes();
        getUnit();
        getUserItem();
        $(itemtypes).each(function (index) {
            $('#selectItemType').append(`
                        <option value="${index}">${this.kind_name}</option>
                    `);
        })
        $(itemtypes).each(function (index) {
            $('#selectImportType').append(`
                        <option value="${index}">${this.kind_name}</option>
                    `);
        })
    });
    function getItemTypes() {
        $.ajax({
            url: `/admin/productmanage/item/itemTypes`,
            type: 'get',
            async: false,
            success: function (response) {
                itemtypes = response;
            }
        })
    }
    function getUnit() {
        $.ajax({
            url: `/admin/productmanage/item/unit`,
            type: 'get',
            success: function (response) {
                itemUnit = response;
            }
        })
    }
    function getUserItem() {
        $.ajax({
            url: `/admin/productmanage/item/userItems`,
            type: 'get',
            success: function (response) {
                userItems = response;
            }
        })
    }

    let timeout = {
        'inputSearchItems': null
    };
    $(document).on('input', '#inputSearchItems', function () {
        if (timeout['inputSearchItems'] != null) {
            clearTimeout(timeout['inputSearchItems']);
        }
        timeout['inputSearchItems'] = setTimeout(initDatatablesItems, 1000);
    });
    $(document).on('change', '#selectItemType', function () {
        initDatatablesItems();
    });
    $(document).on('input', '#inputSearchImports', function () {
        if (timeout['inputSearchItems'] != null) {
            clearTimeout(timeout['inputSearchItems']);
        }
        timeout['inputSearchImports'] = setTimeout(initDatatablesImports, 1000);
    });
    $(document).on('change', '#selectImportType', function () {
        initDatatablesImports();
    });
    function initDatatablesItems() {
        $('#item').DataTable().destroy();
        let datatables_setting_items = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_items["processing"] = true;
        datatables_setting_items["serverSide"] = true;
        datatables_setting_items["ajax"] = {
            "url": "/admin/productmanage/items",
            "data": function (d) {
                d.item_type = $('#selectItemType').val();
                d.search = $('#inputSearchItems').val();
                // d.custom = $('#myInput').val();
                // etc
            }
        };
        datatables_setting_items["columns"] = [
            { "data": "item_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#itemManageModal" data-type="edit" data-id="${row.item_id}" data-name="item_id" disabled>${row.item_name}</button>`;
                }
            },
            { "data": "itemtypes" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<label type="price">${row.price}</label>`;
                }
            },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<label type="amount">${row.amount}</label>`;
                }
            },
            { "data": "unit_name" },
            { "data": "user_name" },
            { "data": "describe" }


        ];
        datatables['item'] = $('#item').DataTable(datatables_setting_items);
    }
    function initDatatablesImports() {
        let datatables_setting_imports = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_imports["processing"] = true;
        datatables_setting_imports["serverSide"] = true;
        datatables_setting_imports["ajax"] = "/admin/productmanage/item/imports";
        datatables_setting_imports["columns"] = [

            { "data": "import_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#importManageModal" data-type="edit" data-id="${row.import_id}" data-name="import_id" disabled>${row.item_name}</button>`;
                }
            },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<label type="import_amount">${row.import_amount}</label>`;
                }
            },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<label type="import_date">${row.import_date || ''}</label>`;
                }
            },
        ];
        datatables['import'] = $('#import').DataTable(datatables_setting_imports);
    }
    function handleModalEditable() {
        $('[name="buttonModalEditable"]').prop('disabled', false);
        $('.dt-checkboxes').prop('disabled', false);
    }

    // #myInput is a <input type="text"> element
    var table = $('#item').DataTable();
    $('#inputSearchItems').on('keyup', function () {
        table.search(this.value).draw();
    });

    $(document).on('show.bs.modal', '#itemManageModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add" || type == "edit") {
            $('#itemManageModal').find('.modal-body').html(`
                <form>
                    <div class="form-group row">
                        <label for="item_name" class="col-form-label col-sm-auto">貨品名稱</label>
                        <div class="col-sm">
                            <input type="text" id="item_name" name="add_item" data-name="item_name" class="form-control"
                                placeholder="ex.文旦" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="price" class="col-form-label col-sm-auto">貨品售價</label>
                        <div class="col-sm">
                            <input type="text" class="form-control" data-name="price" id="price" name="add_item"
                                placeholder="ex.50" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="amount" class="col-form-label col-sm-auto">貨品數量</label>
                        <div class="col-sm">
                            <input type="text" class="form-control" data-name="amount" id="amount" name="add_item"
                                placeholder="ex.30">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="unit" class="col-form-label col-sm-auto">貨品單位</label>
                        <div class="col-sm">
                            <select class="form-control" id="unit" name="add_item" data-name="unit">
                                <option disabled selected>請選擇</option>                      
                            </select>
                        </div>
                    </div>
                    <div class="form-group row form-inline">
                        <label for="item_type" class="col-form-label col-sm-auto">貨品種類</label>
                        <div class="col-sm">
                                <div class="row" id="item_type" data-name="item_type">
                                </div>
                            </div>
                    </div>
                    <div class="form-group row">
                        <label for="describe" class="col-form-label col-sm-auto">貨品文字說明</label>
                        <div class="col-sm">
                            <textarea type="textarea" class="form-control" id="describe" name="add_item" data-name="describe"
                                rows="3" placeholder="ex.此產品鮮嫩多汁"></textarea>
                        </div>
                    </div>
                    <div class="form-group row mx-1">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="add_item_picture" name="add_item" data-name="picture"
                                accept="image/*">
                            <label class="custom-file-label" for="customFile">貨品圖片</label>
                        </div>
                    </div>
                    <div class="form-group d-flex" style="overflow-x:scroll" id="divPreviewPicture">
                    </div>
                </form>
            `);
            $(itemtypes).each(function (index) {
                $('#item_type').append(`
                        <div class="col-sm-4 ">
                            <div class="form-check ">
                                <input type="checkbox" class="form-check-input" name="add_item" id="kind_${this.kind_id}" value="${this.kind_id}" data-name="item_type">
                                <label class="form-check-label" for="kind_${this.kind_id}">${this.kind_name}</label>
                            </div>
                        </div>
                    `);
            })
            $(itemUnit).each(function (index) {
                $('#unit').append(`
                        <option value="${index + 1}">${this.unit_name}</option>
                    `);
            })

            if (type == "add") {
                $('#itemManageModal').find('.modal-title').text('新增貨品');
                $('#itemManageModal').find('.modal-footer').html(`
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureModal"
                            data-dismiss="modal"  data-type="add_item">確認</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                       `);
            } else if (type == "edit") {
                $('#itemManageModal').find('.modal-title').text('編輯貨品');
                $('#itemManageModal').find('.modal-footer').html(`
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureModal"
                                data-dismiss="modal" id="edit_confirm" data-type="revise_item">確認</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>     
                        `);
                let item_id = $(source).attr('data-id');
                $.ajax({
                    url: `/admin/productmanage/item/${item_id}`,
                    type: 'get',
                    data: {
                        item_id: item_id
                    },
                    success: function (response) {
                        $(response).each(function () {
                            let row = this;
                            console.log(row);
                            $('#itemManageModal').find('#item_name').val(row.item_name);
                            $('#itemManageModal').find('#price').val(row.price);
                            $('#itemManageModal').find('#amount').val(row.amount);
                            $('#itemManageModal').find('#describe').val(row.describe);
                            // let unit = row.unit_id;
                            $(`#unit option[value="${row.unit_id}"]`).prop("selected", true);
                            console.log($(`#unit option[value="${row.unit_id - 1}"]`).val());
                            $(row.itemtypes).each(function () {
                                $(`[name="add_item"][value="${this.kind_id}"]`).prop('checked', true);
                            })
                            $('#itemManageModal').find('#edit_confirm').attr('item_id', item_id);
                            // $('#itemManageModal').find('#add_item_name').val(row.item_name);
                            // $('#itemManageModal').find('#add_item_price').val(row.price);
                            // $('#itemManageModal').find('#add_item_amount').val(row.amount);
                            // $('#itemManageModal').find('#add_item_describe').val(row.describe);
                            // let unit = row.unit_id;
                            // $(`#add_item_unit option[value="${unit - 1}"]`).prop("selected", true);

                        })

                    }
                });
            }
        } else if (type == "delete") {
            $('#itemManageModal').find('.modal-body').html('確定刪除嗎？');
            $('#itemManageModal').find('.modal-title').text('刪除貨品');
            $('#itemManageModal').find('.modal-footer').html(`
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="delete_item_row">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                `);

        }
    })
    $(document).on('show.bs.modal', '#sureModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add_item") {
            $('#sureModal').find('.modal-title').text('新增貨品');
            $('#sureModal').find('.modal-body').text('確定新增嗎？');

        } else if (type == "revise_item") {
            $('#sureModal').find('.modal-title').text('編輯貨品');
            $('#sureModal').find('.modal-body').text('確定編輯嗎？');
        } else if (type == "add_import") {
            $('#sureModal').find('.modal-title').text('新增進貨');
            $('#sureModal').find('.modal-body').text('確定新增嗎？');
        } else if (type == "revise_import") {
            $('#sureModal').find('.modal-title').text('編輯進貨');
            $('#sureModal').find('.modal-body').text('確定編輯嗎？');
        }
        $('#sureModal').find('.modal-footer').find("#sure").attr("type", type);
    })
    $(document).on('show.bs.modal', '#importManageModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add" || type == "edit") {
            $('#importManageModal').find('.modal-body').html(`
                <form>
                    <div class="form-group row">
                        <label for="item_id" class="col-form-label col-sm-auto">貨品名稱</label>
                        <div class="col-sm">
                            <select class="form-control" id="item_id" name="add_import" >
                                <option disabled selected>請選擇</option>                      
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                            <label for="import_amount" class="col-form-label col-sm-auto">進貨數量</label>
                            <div class="col-sm">
                                <input type="text" class="form-control" id="import_amount" name="add_import" placeholder="ex.30">
                            </div>
                        </div>
                    <div class="form-group row">
                            <label for="import_date" class="col-form-label col-sm-auto">進貨時間</label>
                            <div class="col-sm">
                                <input type="date" class="form-control" name="add_import" id="import_date" name="date">
                            </div>
                        </div>
                </form>
            `);
            $(userItems).each(function (index) {
                $('#item_id').append(`
                        <option value="${index}">${this.item_name}</option>
                    `);
            })
            if (type == "add") {
                $('#importManageModal').find('.modal-title').text('新增進貨');
                $('#importManageModal').find('.modal-footer').html(`
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureModal"
                        data-dismiss="modal" data-type="add_import">確認</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                `);
            } else if (type == "edit") {
                $('#importManageModal').find('.modal-title').text('編輯進貨');
                $('#importManageModal').find('.modal-footer').html(`
                    <button type="button" class="btn btn-primary" data-toggle="modal" id="edit_confirm" data-target="#sureModal"
                        data-dismiss="modal" data-type="revise_import">確認</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                `);
                let import_id = $(source).attr('data-id');
                $.ajax({
                    url: `/admin/productmanage/item/import/${import_id}`,
                    type: 'get',
                    data: {
                        import_id: import_id
                    },
                    success: function (response) {
                        $(response).each(function () {
                            let row = this;
                            let name = row.item_id;
                            $(`#item_id option[value="${name - 1}"]`).prop("selected", true);
                            $('#importManageModal').find('#import_amount').val(row.import_amount);
                            $('#importManageModal').find('#import_date').val(row.import_date !== null ? row.import_date.substring(0, 10) : '');

                            $('#importManageModal').find('#item_id').attr('disabled', true);
                            $('#importManageModal').find('#edit_confirm').attr('import_id', import_id);
                        })
                    }
                });
            }

        } else if (type == "delete") {
            $('#importManageModal').find('.modal-body').html('確定刪除嗎？');
            $('#importManageModal').find('.modal-title').text('刪除進貨');
            $('#importManageModal').find('.modal-footer').html(`
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="delete_import_row">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            `);
        }
    })

    $(document).on('change', '#add_item_picture', function (e) {
        let file_data = $('#add_item_picture').prop('files')[0];
        form_data = new FormData();
        form_data.append('file', file_data);
        $.ajax({
            url: '/admin/productmanage/item/upload', // <-- point to server-side PHP script 
            cache: false,
            contentType: false,
            processData: false,
            data: form_data,
            type: 'post',
            success: function (response) {
                /* 
                php_script_response = [
                    {   file_id :1 },
                ]
                    */
                // alert(php_script_response); // <-- display response from the PHP script, if any
                file_ids = [];
                $(response).each(function () {
                    file_ids.push(this.file_id);
                })
                console.log(file_ids);
                previewPicture();
            },
            complete: function () {
                $('#add_item_picture').val('');
            }
        });
    })
    function previewPicture() {
        $('#divPreviewPicture').empty(``);
        $.each(file_ids, function () {
            $('#divPreviewPicture').append(`
                <div class="col-4">
                    <img src="/admin/productmanage/item/file/${this}" class="img img-fluid"/>
                </div>
            `);
        })
    }
    $(document).on('click', '#sure', function (e) {
        let type = $(this).attr("type");
        let data = {};
        let form = {};
        if (type === "add_item") {
            data = {};
            $("[name='add_item']").each(function (index, obj) {
                index = $(this).attr("data-name");
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    if (this.type == "text") {
                        obj = $(this).val();
                        data[index] = obj;
                    } else if (this.type == "select-one") {
                        obj = $(this).val();
                        data[index] = obj;
                    } else if (this.type == "checkbox") {
                        obj = [];
                        $("input:checkbox[name=add_item]:checked").each(function () {
                            obj.push($(this).val());
                        });
                        data[index] = obj;
                    } else if (this.type == "textarea") {
                        obj = $(this).val();
                        data[index] = obj;
                    } else if (this.type == "file") {
                        obj = file_ids;
                        data[index] = obj;
                    }
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            if (check == true) {
                $.ajax({
                    url: `/admin/productmanage/item/additem`,
                    type: 'post',
                    data: data,
                    dataType: 'json',
                    success: function (response) {
                        // $("[name='add_item']").each(function () {
                        //     $('#item').find(`[data-id="${data['item_id']}"]`).closest(`tr`).find(`[type="${this.id}"]`).text(data[`${this.id}`]);
                        // })
                        datatables['item'].draw(false);
                    }
                })
            } else {
                $("#itemManageModal").modal('show');
            }
        } else if (type === 'revise_item') {
            data = {};
            $("[name='add_item']").each(function (index, obj) {
                index = $(this).attr("data-name");
                // if ($(this).val() != '') {
                //     $(this).removeClass('is-invalid').addClass('is-valid');
                if (this.type == "text") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "select-one") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "checkbox") {
                    obj = [];
                    $("input:checkbox[name=add_item]:checked").each(function () {
                        obj.push($(this).val());
                    });
                    data[index] = obj;
                } else if (this.type == "textarea") {
                    obj = $(this).val();
                    data[index] = obj;
                } else if (this.type == "file") {
                    obj = file_ids;
                    data[index] = obj;
                }
                // } else {
                //     check = false;
                //     $(this).removeClass('is-valid').addClass('is-invalid');
                // }

            });
            data['item_id'] = $('#itemManageModal').find('#edit_confirm').attr('item_id');
            console.log(data);
            // if (check == true) {
            $.ajax({
                url: `/admin/productmanage/item/edititem`,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function (response) {
                    // console.log(`datatables['item'].draw(false);`);
                    datatables['item'].draw(false);
                }
            })
            // } else {
            //     $("#itemManageModal").modal('show');
            // }
        } else if (type === 'add_import') {
            let data = new Object();
            let check = true;
            $("[name='add_import']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            if (check === true) {
                $.ajax({
                    url: `/admin/productmanage/item/import/addimport`,
                    type: 'post',
                    data: data,
                    success: function (response) {
                        datatables['import'].draw(false);
                    }
                })
            } else {
                $("#importManageModal").modal('show');
            }

        } else if (type === 'revise_import') {
            let data = new Object();
            let check = true;
            $("[name='add_import']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            data['import_id'] = $('#importManageModal').find('#edit_confirm').attr('import_id');
            if (check === true) {
                $.ajax({
                    url: `/admin/productmanage/item/import/editimport`,
                    type: 'post',
                    data: data,
                    success: function (response) {
                        $("[name='add_import']").each(function () {
                            $('#import').find(`[data-id="${data['import_id']}"]`).closest(`tr`).find(`[type="${this.id}"]`).text(data[`${this.id}`]);
                        })

                    }
                })
            } else {
                $("#importManageModal").modal('show');
            }
        }
    })
    $(document).on('click', '#delete_import_row', function (e) {
        let data_arr = [];
        let data = {};
        $('input[type="checkbox"]:checked').each(function () {
            data = {};
            data['import_id'] = $(this).closest(`tr`).find(`[data-name="import_id"]`).attr('data-id');
            data_arr.push(data);
        });
        $.ajax({
            url: `/admin/productmanage/item/import/deleteimport`,
            type: 'post',
            data: {
                data: data_arr
            },
            success: function (response) {
                initDatatablesImports();
            }
        })
    })
    $(document).on('click', '#delete_item_row', function (e) {
        let data_arr = [];
        let data = {};
        $('input[type="checkbox"]:checked').each(function () {
            data = {};
            data['item_id'] = $(this).closest(`tr`).find(`[data-name="item_id"]`).attr('data-id');
            data_arr.push(data);
        });
        $.ajax({
            url: `/admin/productmanage/item/deleteitem`,
            type: 'post',
            data: {
                data: data_arr
            },
            success: function (response) {
                initDatatablesItems();
            }
        })
    })
    // $(document).on('click', '#export_item', function (e) {
    //     $.ajax({
    //         url: `/admin/productmanage/item/exportitem`,
    //         type: 'get',
    //         success: function (response) {
    //         }
    //     })
    // })
</script>