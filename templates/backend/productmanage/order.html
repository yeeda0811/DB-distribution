<?php include(__DIR__ . '/../basic/header.html'); ?>
<div class="container-fluid">
    <div class="card">
        <div class="card-header">訂單管理</div>
        <div class="card-body">
            <div class="row">
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#orderManageModal"
                        data-type="add">新增</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-secondary" onclick="handleModalEditable()">修改</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#orderManageModal"
                        data-type="delete">刪除</button>
                </div>
                <div class="form-group col-auto">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#orderManageModal"
                        data-type="export">匯出</button>
                </div>
            </div>
            <div class="row">
                <div class="col-auto row form-group">
                    <label class="col-form-label col-auto">搜尋：</label>
                    <div class="col-auto">
                        <input type="text" class="form-control" id="inputSearchItems" />
                    </div>
                </div>
            </div>
            <table class="table table-striped table-bordered" id="order" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th>訂單編號</th>
                        <th>訂單人</th>
                        <th>折扣內容</th>
                        <th>折扣金額</th>
                        <th>付款方式</th>
                        <th>總金額</th>
                        <th>訂單日期</th>
                        <th>付款日期</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<!-- reviseModal -->
<div class="modal fade" id="sureOrderModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">修改訂單</h5>
            </div>
            <div class="modal-body">
                確定修改嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="sureOrder">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="orderManageModal" tabindex="-1" aria-labelledby="orderManageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="orderManageModalLabel"></h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">確認</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<?php include(__DIR__ . '/../basic/footer.html'); ?>
<script type="text/javascript">
    let datatables_setting = {
        "ordering": false,
        "destroy": true,
        "searching": false,
        "language": {
            "processing": "處理中...",
            "loadingRecords": "載入中...",
            "lengthMenu": "顯示 _MENU_ 項結果",
            "zeroRecords": "沒有符合的結果",
            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
            "infoFiltered": "(從 _MAX_ 項結果中過濾)",
            "infoPostFix": "",
            "search": "搜尋:",
            "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
            },
            "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
            }
        },
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true
            }
        }],
        'select': {
            'style': 'multi'
        },
    };
    let payingtypes = [];
    $(function () {
        initDatatablesOrders();
        getPayingType();
    });
    function getPayingType() {
        $.ajax({
            url: `/admin/productmanage/order/payingTypes`,
            type: 'get',
            success: function (response) {
                payingtypes = response;
            }
        })
    }
    let timeout = {
        'inputSearchOrders': null
    };
    $(document).on('input', '#inputSearchOrders', function () {
        if (timeout['inputSearchOrders'] != null) {
            clearTimeout(timeout['inputSearchOrders']);
        }
        timeout['inputSearchOrders'] = setTimeout(initDatatablesOrders, 1000);
    });
    $(document).on('change', '#selectOrderType', function () {
        initDatatablesOrders();
    });
    function initDatatablesOrders() {
        $('#order').DataTable().destroy();
        let datatables_setting_orders = JSON.parse(JSON.stringify(datatables_setting));
        datatables_setting_orders["processing"] = true;
        datatables_setting_orders["serverSide"] = true;
        datatables_setting_orders["ajax"] = {
            "url": "/admin/productmanage/orders",
            "data": function (d) {
                d.item_type = $('#selectOrderType').val();
                d.search = $('#inputSearchOrders').val();
                // d.custom = $('#myInput').val();
                // etc
            }
        };
        datatables_setting_orders["columns"] = [
            { "data": "order_id" },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button type="button" class="btn btn-link" name="buttonModalEditable" data-toggle="modal" data-target="#orderManageModal" data-type="edit" data-id="${row.order_id}" disabled>${row.order_id}</button>`;
                }
            },
            { "data": "user_name" },
            { "data": "discount_name" },
            { "data": "discount_pay" },
            { "data": "paying_name" },
            { "data": "order_sum" },
            { "data": "order_date" },
            { "data": "paying_date" }

        ];
        $('#order').DataTable(datatables_setting_orders);
    }
    function handleModalEditable() {
        $('[name="buttonModalEditable"]').prop('disabled', false);
    }
    $(document).on('show.bs.modal', '#orderManageModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add" || type == "edit") {
            $('#orderManageModal').find('.modal-body').html(`
                        <form>
                            <div class="form-group row">
                                    <label for="order_user" class="col-form-label col-sm-auto">訂單人</label>
                                    <div class="col-sm">
                                        <input type="text" class="form-control" id="order_user" name="add_order" placeholder="ex.yeeda">
                                    </div>
                                </div>
                            <div class="form-group row">
                                    <label for="order_discount" class="col-form-label col-sm-auto">折扣卷序號</label>
                                    <div class="col-sm">
                                        <input type="text" class="form-control" id="discount_id" name="add_order" placeholder="ex.1">
                                    </div>
                                </div>
                            <div class="form-group row">
                                <label for="paying_type" class="col-form-label col-sm-auto">付款方式</label>
                                <div class="col-sm">
                                    <select class="form-control" id="paying_id" name="add_order">
                                        <option disabled selected>請選擇</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="order_sum" class="col-form-label col-sm-auto">總金額：</label>
                                <div class="col-sm">
                                    <input type="text" class="form-control" id="order_sum" name="add_order" placeholder="ex.580">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="order_date" class="col-form-label col-sm-auto">訂單日期：</label>
                                <div class="col-sm">
                                    <input type="date" class="form-control" id="order_date" name="add_order">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="paying_date" class="ccol-form-label col-sm-auto">付款日期：</label>
                                <div class="col-sm">
                                    <input type="date" class="form-control" id="paying_date" name="add_order">
                                </div>
                            </div>
                        </div>
                        </form>
                    `);
            $(payingtypes).each(function (index) {
                $('#paying_id').append(`
                        <option value="${index}">${this.paying_name}</option>
                    `);
            })
            if (type == "add") {
                $('#orderManageModal').find('.modal-title').text('新增訂單');
                $('#orderManageModal').find('.modal-footer').html(`
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureOrderModal"
                                data-dismiss="modal" data-type="add_order">確認</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            `);
            } else if (type == "edit") {
                $('#orderManageModal').find('.modal-title').text('編輯訂單');
                $('#orderManageModal').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sureOrderModal"
                            data-dismiss="modal" data-type="revise_order" id="order_edit_confirm">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        `);
                let order_id = $(source).attr('data-id');
                $.ajax({
                    url: `/admin/productmanage/order/${order_id}`,
                    type: 'get',
                    data: {
                        order_id: order_id
                    },
                    success: function (response) {
                        $(response).each(function () {
                            let row = this;
                            $('#orderManageModal').find('#order_user').val(row.user_name);
                            $('#orderManageModal').find('#discount_id').val(row.discount_id);
                            $(`#paying_id option[value="${row.paying_id - 1}"]`).prop("selected", true);
                            $('#orderManageModal').find('#order_sum').val(row.order_sum);
                            $('#orderManageModal').find('#order_date').val(row.order_date !== null ? row.order_date.substring(0, 10) : '');
                            $('#orderManageModal').find('#paying_date').val(row.paying_date !== null ? row.paying_date.substring(0, 10) : '');
                            $('#orderManageModal').find('#order_edit_confirm').attr('order_id', order_id);
                        })
                    }
                });

            }
        } else if (type == "delete") {
            $('#orderManageModal').find('.modal-body').html('確定刪除嗎？');
            $('#orderManageModal').find('.modal-title').text('刪除訂單');
            $('#orderManageModal').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary">確認</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        `);
        }
    })
    $(document).on('show.bs.modal', '#sureOrderModal', function (e) {
        let source = e.relatedTarget;
        let type = $(source).attr('data-type');
        if (type == "add_order") {
            $('#sureOrderModal').find('.modal-title').text('新增訂單');
            $('#sureOrderModal').find('.modal-body').text('確定新增嗎？');
        } else if (type == "revise_order") {
            $('#sureOrderModal').find('.modal-title').text('編輯訂單');
            $('#sureOrderModal').find('.modal-body').text('確定編輯嗎？');
        }
        $('#sureOrderModal').find('.modal-footer').find("#sureOrder").attr("type", type);
    })
    $(document).on('click', '#sureOrder', function (e) {
        let type = $(this).attr("type");
        console.log(type);
        let data = {};
        let form = {};
        let check = true;
        if (type === "add_order") {
            data = new Object();
            $("[name='add_order']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            console.log(data);
            if (check === true) {
                $.ajax({
                    url: `/admin/productmanage/order/addorder`,
                    type: 'post',
                    data: data,
                    success: function (response) {
                    }
                })
            } else {
                $("#discountManageModal").modal('show');
            }
        } else if (type == "revise_order") {
            let data = new Object();
            let check = true;
            $("[name='add_order']").each(function () {
                if ($(this).val() != '') {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    data[this.id] = $(this).val();
                    console.log(data);
                } else {
                    check = false;
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            data['order_id'] = $('#orderManageModal').find('#order_edit_confirm').attr('order_id');
            console.log(data);
            // if (check === true) {
            //     $.ajax({
            //         url: `/admin/productmanage/item/import/editimport`,
            //         type: 'post',
            //         data: data,
            //         success: function (response) {
            //             $("[name='add_import']").each(function () {
            //                 $('#import').find(`[data-id="${data['import_id']}"]`).closest(`tr`).find(`[type="${this.id}"]`).text(data[`${this.id}`]);
            //             })
            //         }
            //     })
            // } else {
            //     $("#importManageModal").modal('show');
            // }



        }
    })
</script>